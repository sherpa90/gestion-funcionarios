{% extends 'base.html' %}

{% block page_title %}Cargar Registros del Reloj Control{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900">Cargar Registros del Reloj Control</h2>
        <p class="text-gray-600 mt-2">Sube el archivo Excel con los registros de asistencia del reloj control para procesar autom√°ticamente</p>
    </div>

    <!-- Informaci√≥n del Formato -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Formatos Soportados</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p><strong>Para archivos Excel (.xlsx/.xls):</strong> El archivo debe contener las siguientes columnas:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>Columna A - R.U.T.:</strong> N√∫mero de RUT (con puntos y guiones)</li>
                        <li><strong>Columna B - Nombre:</strong> Nombre completo del funcionario</li>
                        <li><strong>Columna C - Horario:</strong> Fecha y hora en formato "DD-MM-YYYY HH:MM"</li>
                    </ul>
                    <p class="mt-3"><strong>Para archivos PDF con formato "RUT, Nombre Horario":</strong></p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Ejemplo: <code>12345678-9, Juan P√©rez 08:30-17:30</code></li>
                        <li>La fecha se toma de los campos Mes/A√±o que especificas abajo</li>
                        <li>El horario puede ser "08:30" o "08:30-17:30" (hora salida opcional)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Carga -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Seleccionar Archivo Excel</h3>
        </div>

        <form method="post" enctype="multipart/form-data" class="p-6">
            {% csrf_token %}

            <!-- Campo de Archivo -->
            <div class="mb-6">
                <label for="{{ form.archivo_excel.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Archivo de Registros
                </label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-gray-400 transition-colors">
                    <div class="space-y-1 text-center">
                        <i class="fas fa-file-excel text-4xl text-green-500 mb-4"></i>
                        <div class="flex text-sm text-gray-600">
                            <label for="{{ form.archivo_excel.id_for_label }}" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                <span>Subir un archivo</span>
                                {{ form.archivo_excel }}
                            </label>
                            <p class="pl-1">o arrastrar y soltar</p>
                        </div>
                        <p class="text-xs text-gray-500">Excel (.xlsx/.xls) o PDF hasta 10MB</p>
                    </div>
                </div>
                {% if form.archivo_excel.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.archivo_excel.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Campos de Fecha (para PDFs sin fecha) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="{{ form.mes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Mes
                    </label>
                    {{ form.mes }}
                    {% if form.mes.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.mes.errors.0 }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.anio.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        A√±o
                    </label>
                    {{ form.anio }}
                    {% if form.anio.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.anio.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Informaci√≥n Adicional -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Informaci√≥n del Proceso</h4>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>‚Ä¢ Se procesar√°n todos los RUTs encontrados en el archivo</li>
                    <li>‚Ä¢ Se comparar√°n autom√°ticamente con los horarios estipulados</li>
                    <li>‚Ä¢ Se calcular√°n retrasos y tiempos trabajados</li>
                    <li>‚Ä¢ Los registros existentes se actualizar√°n</li>
                    <li>‚Ä¢ El proceso puede tardar unos minutos seg√∫n el tama√±o del archivo</li>
                </ul>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex items-center justify-end space-x-3">
                <a href="{% url 'asistencia:gestion_asistencia' %}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </a>
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-upload mr-2"></i> Procesar Archivo
                </button>
            </div>
        </form>
    </div>

    <!-- Ejemplos de Archivos -->
    <div class="mt-8 space-y-6">
        <!-- Formato B√°sico -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üìã Formato B√°sico (3 columnas)</h3>
                <p class="text-sm text-gray-600 mt-1">Compatible con archivos existentes</p>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">R.U.T.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horario</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">9479036-0</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">CRISTIAN CACERES O.</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">06-11-2025 08:38</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">10677028-K</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">MARCIA INOSTROZA A.</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">06-11-2025 17:23</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Formato Avanzado AM/PM -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üïê Formato Avanzado AM/PM (5 columnas) - RECOMENDADO</h3>
                <p class="text-sm text-gray-600 mt-1">Registra entrada y salida por separado</p>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">R.U.T.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora AM</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora PM</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">9479036-0</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">CRISTIAN CACERES O.</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">06/11/2025</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">08:38</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-600 font-medium">17:45</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">10677028-K</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">MARCIA INOSTROZA A.</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">06/11/2025</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">08:15</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-600 font-medium">17:30</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">11218216-0</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">RAUL GARCIA MANCILLA</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">06/11/2025</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">08:00</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400">‚Äî</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-green-50 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-lightbulb text-green-600 mt-0.5 mr-2"></i>
                        <div>
                            <p class="text-sm font-medium text-green-800">üí° Ventajas del formato AM/PM:</p>
                            <ul class="text-sm text-green-700 mt-1 space-y-1">
                                <li>‚Ä¢ Registra <strong>hora de entrada</strong> (AM) y <strong>hora de salida</strong> (PM) por separado</li>
                                <li>‚Ä¢ Calcula autom√°ticamente el <strong>tiempo trabajado</strong></li>
                                <li>‚Ä¢ M√°s preciso para control de asistencia</li>
                                <li>‚Ä¢ Compatible con relojes que registran entrada/salida</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notas Generales -->
    <div class="mt-6 bg-gray-50 border-l-4 border-gray-400 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-gray-400"></i>
            </div>
            <div class="ml-3">
                <h4 class="text-sm font-medium text-gray-800">Notas Generales</h4>
                <ul class="text-sm text-gray-600 mt-2 space-y-1">
                    <li>‚Ä¢ Los RUTs pueden tener puntos y guiones (se normalizan autom√°ticamente)</li>
                    <li>‚Ä¢ El sistema <strong>detecta autom√°ticamente</strong> el formato del archivo</li>
                    <li>‚Ä¢ La primera fila se considera encabezados y se ignora</li>
                    <li>‚Ä¢ Los registros se comparan autom√°ticamente con los horarios estipulados</li>
                    <li>‚Ä¢ Se calculan retrasos y tiempos trabajados cuando hay hora de salida</li>
                    <li>‚Ä¢ Los registros existentes se actualizan (no se duplican)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Preview del archivo seleccionado
document.getElementById('id_archivo_excel').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        
        // Actualizar el texto del label
        const label = document.querySelector('label[for="id_archivo_excel"]');
        label.innerHTML = `<span>${fileName}</span> <span class="text-gray-500">(${fileSize} MB)</span>`;
    }
});
</script>
{% endblock %}