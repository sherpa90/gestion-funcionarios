{% extends 'base.html' %}

{% block title %}Mis Equipos - SGPAL{% endblock %}
{% block page_title %}Mi Inventario Personal{% endblock %}

{% block content %}
<div class="p-4 sm:p-6 lg:p-8 bg-gray-50/50 min-h-full">
    <div class="max-w-6xl mx-auto space-y-8">

        <!-- Welcome Header -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div>
                <nav class="flex mb-4" aria-label="Breadcrumb">
                    <ol class="inline-flex items-center space-x-1 md:space-x-3 text-xs font-medium text-gray-500">
                        <li class="inline-flex items-center">
                            <i class="fa-solid fa-home mr-2"></i> Dashboard
                        </li>
                        <li>
                            <div class="flex items-center">
                                <i class="fa-solid fa-chevron-right mx-2 opacity-30"></i>
                                <span>Mi Gestión</span>
                            </div>
                        </li>
                    </ol>
                </nav>
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Mis Herramientas de Trabajo</h1>
                <p class="mt-2 text-lg text-gray-600 max-w-2xl">Visualiza y gestiona los equipos asignados legalmente a
                    tu cargo para el desempeño de tus funciones.</p>
            </div>

            {% if prestamos %}
            <div class="flex flex-wrap items-center gap-3">
                <a href="{% url 'reporte_prestamos_pdf' user.id %}"
                    class="inline-flex items-center px-5 py-2.5 bg-white border border-gray-200 text-gray-700 font-semibold rounded-2xl shadow-sm hover:bg-gray-50 hover:border-gray-300 transition-all active:scale-95">
                    <i class="fa-solid fa-file-pdf text-red-500 mr-2"></i>
                    Descargar Resumen PDF
                </a>
            </div>
            {% endif %}
        </div>

        {% if prestamos %}
        <!-- Stats Row -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600">
                    <i class="fa-solid fa-boxes-stacked fa-lg"></i>
                </div>
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ prestamos.count }}</div>
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Equipos Totales</div>
                </div>
            </div>

            {% with laptops=prestamos|dictsort:"equipo.tipo" %}
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600">
                    <i class="fa-solid fa-laptop fa-lg"></i>
                </div>
                <div>
                    <div class="text-2xl font-bold text-gray-900">
                        {% regroup prestamos by equipo.tipo as tipo_list %}
                        {% for tipo in tipo_list %}
                        {% if tipo.grouper == 'LAPTOP' %}{{ tipo.list|length }}{% endif %}
                        {% endfor %}
                    </div>
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Computadores</div>
                </div>
            </div>
            {% endwith %}

            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-green-50 rounded-2xl flex items-center justify-center text-green-600">
                    <i class="fa-solid fa-shield-check fa-lg"></i>
                </div>
                <div>
                    <div class="text-2xl font-bold text-gray-900">Activo</div>
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Estado Custodia</div>
                </div>
            </div>
        </div>

        <!-- Equipment Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {% for prestamo in prestamos %}
            <div
                class="group bg-white rounded-[2rem] border border-gray-100 shadow-sm hover:shadow-xl hover:border-blue-100 transition-all duration-300 overflow-hidden flex flex-col sm:flex-row">
                <!-- Visual Icon Side -->
                <div
                    class="sm:w-32 bg-gray-50/50 flex items-center justify-center p-6 sm:p-0 border-b sm:border-b-0 sm:border-r border-gray-50">
                    <div
                        class="w-16 h-16 rounded-3xl bg-white shadow-inner flex items-center justify-center text-gray-400 group-hover:text-blue-500 transition-colors">
                        {% if prestamo.equipo.tipo == 'LAPTOP' %}
                        <i class="fa-solid fa-laptop fa-2x"></i>
                        {% elif prestamo.equipo.tipo == 'CELULAR' %}
                        <i class="fa-solid fa-mobile-screen-button fa-2x"></i>
                        {% elif prestamo.equipo.tipo == 'IMPRESORA' %}
                        <i class="fa-solid fa-print fa-2x"></i>
                        {% else %}
                        <i class="fa-solid fa-desktop fa-2x"></i>
                        {% endif %}
                    </div>
                </div>

                <!-- Info Side -->
                <div class="flex-1 p-6 space-y-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-2">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 group-hover:text-blue-600 transition-colors">
                                {{ prestamo.equipo.marca }} {{ prestamo.equipo.modelo }}
                            </h3>
                            <span
                                class="inline-block px-2 py-0.5 mt-1 bg-gray-100 text-gray-500 text-[10px] font-bold rounded-lg uppercase tracking-tight">
                                {{ prestamo.equipo.get_tipo_display }}
                            </span>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-0.5">N°
                                Inventario</span>
                            <span class="text-sm font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-xl">#{{
                                prestamo.equipo.numero_inventario }}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 py-4 border-y border-gray-50">
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest block mb-1">Fecha
                                Asignación</span>
                            <div class="flex items-center text-gray-700 text-sm font-semibold">
                                <i class="fa-solid fa-calendar-day mr-2 text-gray-300"></i>
                                {{ prestamo.fecha_asignacion|date:"d M, Y" }}
                            </div>
                        </div>
                        <div>
                            <span
                                class="text-[10px] text-gray-400 font-bold uppercase tracking-widest block mb-1">Número
                                de Serie</span>
                            <div class="flex items-center text-gray-700 text-xs font-mono font-bold truncate"
                                title="{{ prestamo.equipo.numero_serie }}">
                                <i class="fa-solid fa-barcode mr-2 text-gray-300"></i>
                                {{ prestamo.equipo.numero_serie|striptags }}
                            </div>
                        </div>
                    </div>

                    {% if prestamo.observaciones %}
                    <div class="flex gap-3 bg-blue-50/30 p-4 rounded-2xl border border-blue-50/50">
                        <i class="fa-solid fa-circle-info text-blue-200 mt-0.5"></i>
                        <div class="text-xs text-blue-800 leading-relaxed italic line-clamp-2">
                            "{{ prestamo.observaciones }}"
                        </div>
                    </div>
                    {% endif %}

                    <!-- Action Button -->
                    <div class="pt-2">
                        <button
                            onclick="openFallaModal('{{ prestamo.equipo.id }}', '{{ prestamo.equipo.marca }} {{ prestamo.equipo.modelo }}', '{{ prestamo.equipo.tipo }}')"
                            class="inline-flex items-center px-4 py-2 bg-red-50 text-red-600 text-xs font-bold rounded-xl hover:bg-red-600 hover:text-white transition-all active:scale-95 group/btn">
                            <i class="fa-solid fa-triangle-exclamation mr-2 group-hover/btn:animate-pulse"></i>
                            Reportar Falla
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <!-- Ultra Clean Empty State -->
        <div
            class="bg-white rounded-[3rem] shadow-sm border border-gray-100 p-16 text-center max-w-2xl mx-auto border-dashed">
            <div class="w-32 h-32 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-8">
                <i class="fa-solid fa-ghost fa-4x text-gray-200 animate-pulse"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-900 mb-3">Sin equipos asignados</h3>
            <p class="text-gray-500 text-lg leading-relaxed mb-8">Parece que actualmente no tienes herramientas de
                trabajo vinculadas a tu cuenta personal.</p>
            <a href="{% url 'dashboard' %}"
                class="inline-flex items-center text-blue-600 font-extrabold hover:underline">
                Volver al inicio <i class="fa-solid fa-arrow-right ml-2 text-sm"></i>
            </a>
        </div>
        {% endif %}

        <!-- Footer Help -->
        <div class="pt-8 pb-12">
            <div class="bg-gray-900 rounded-[2.5rem] p-8 sm:p-12 text-white relative overflow-hidden">
                <div class="relative z-10 flex flex-col lg:flex-row items-center justify-between gap-8">
                    <div class="text-center lg:text-left">
                        <h4 class="text-2xl font-bold mb-2">¿Necesitas soporte técnico?</h4>
                        <p class="text-gray-400 max-w-md">Si alguno de tus equipos presenta fallas o la información
                            mostrada no es correcta, abre un ticket con administración.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button
                            class="px-8 py-3 bg-white text-gray-900 font-bold rounded-2xl hover:bg-blue-500 hover:text-white transition-all shadow-lg active:scale-95">
                            Reportar Falla
                        </button>
                    </div>
                </div>
                <!-- Abstract backgrounds -->
                <div class="absolute -right-16 -top-16 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"></div>
                <div class="absolute -left-16 -bottom-16 w-64 h-64 bg-indigo-600/10 rounded-full blur-3xl"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Reporte de Falla -->
<div id="fallaModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" id="closeModalBg"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white rounded-[2.5rem] text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="fallaForm" method="POST" action="">
                {% csrf_token %}
                <div class="bg-white p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Reportar Problema</h3>
                            <p class="text-sm text-gray-500 mt-1">Tu reporte será enviado al equipo técnico.</p>
                        </div>
                        <button type="button" id="closeModalBtn"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fa-solid fa-times text-lg"></i>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-2xl flex items-center gap-4 border border-blue-100/50">
                            <div
                                class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-blue-600 shadow-sm">
                                <i class="fa-solid fa-laptop fa-lg" id="modalIcon"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Equipo a
                                    reportar</p>
                                <p class="text-base font-bold text-blue-900" id="modalEquipoName"></p>
                            </div>
                        </div>

                        <div>
                            <label for="descripcion"
                                class="block text-xs font-bold text-gray-400 mb-3 uppercase tracking-widest">
                                ¿Qué está fallando?
                            </label>
                            <textarea id="descripcion" name="descripcion" rows="4"
                                class="w-full px-5 py-4 rounded-3xl border border-gray-100 bg-gray-50/50 focus:bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition-all outline-none resize-none text-gray-700 placeholder-gray-300 font-medium"
                                placeholder="Describe el problema de la manera más detallada posible..."
                                required></textarea>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-8 flex flex-col sm:flex-row-reverse gap-3">
                    <button type="submit"
                        class="w-full sm:w-auto px-10 py-4 bg-gray-900 text-white font-bold rounded-2xl hover:bg-blue-600 shadow-xl shadow-gray-200 transition-all active:scale-95">
                        Enviar Reporte
                    </button>
                    <button type="button" id="cancelModalBtn"
                        class="w-full sm:w-auto px-10 py-4 bg-white text-gray-500 font-bold rounded-2xl border border-gray-200 hover:bg-gray-50 transition-all">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Transiciones suaves y efectos premium */
    .tracking-tight {
        letter-spacing: -0.025em;
    }

    .tracking-widest {
        letter-spacing: 0.1em;
    }

    /* Prevenir cursiva heredada en algunos navegadores */
    .italic-none {
        font-style: normal !important;
    }

    /* Mejora de la animación de pulso para el botón de reporte */
    @keyframes pulse-soft {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }
</style>

<script>
    function openFallaModal(equipoId, equipoName, tipo) {
        const modal = document.getElementById('fallaModal');
        const form = document.getElementById('fallaForm');
        const nameSpan = document.getElementById('modalEquipoName');
        const icon = document.getElementById('modalIcon');

        // Configurar acción dinámica del formulario
        form.action = `/equipos/falla/reportar/${equipoId}/`;
        nameSpan.innerText = equipoName;

        // Cambiar ícono según tipo
        icon.className = 'fa-solid';
        if (tipo === 'LAPTOP') icon.classList.add('fa-laptop');
        else if (tipo === 'CELULAR') icon.classList.add('fa-mobile-screen-button');
        else if (tipo === 'IMPRESORA') icon.classList.add('fa-print');
        else icon.classList.add('fa-desktop');

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeFallaModal() {
        const modal = document.getElementById('fallaModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    document.getElementById('closeModalBtn').addEventListener('click', closeFallaModal);
    document.getElementById('cancelModalBtn').addEventListener('click', closeFallaModal);
    document.getElementById('closeModalBg').addEventListener('click', closeFallaModal);

    // Cerrar con la tecla Escape
    document.addEventListener('keydown', function (event) {
        if (event.key === "Escape") {
            closeFallaModal();
        }
    });

    // Vincular el botón del footer también
    document.addEventListener('DOMContentLoaded', function () {
        const footerBtn = document.querySelector('button.px-8.py-3.bg-white');
        if (footerBtn && footerBtn.innerText.includes('Reportar Falla')) {
            footerBtn.addEventListener('click', function () {
                // Si hay equipos, abrir el modal con el primero por defecto o simplemente alertar
                {% if prestamos %}
                const first = {
                    id: '{{ prestamos.0.equipo.id }}',
                    name: '{{ prestamos.0.equipo.marca }} {{ prestamos.0.equipo.modelo }}',
                    tipo: '{{ prestamos.0.equipo.tipo }}'
                };
                openFallaModal(first.id, first.name, first.tipo);
                {% else %}
                alert('No tienes equipos asignados para reportar fallas.');
                {% endif %}
            });
        }
    });
</script>
{% endblock %}